<section class="dashboard-page">
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="welcome">
                <h1>Hello, {{ user?.name }}! ğŸ‘‹</h1>
                <p>Track your orders and message farmers here.</p>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2>My Orders</h2>
            </div>

            @if (isLoading()) {
            <div class="loading-state">Loading your orders...</div>
            } @else if (orders().length === 0) {
            <div class="empty-state">
                <span class="icon">ğŸ“¦</span>
                <p>You haven't placed any orders yet.</p>
                <a routerLink="/products" class="btn btn-primary">Start Shopping</a>
            </div>
            } @else {
            <div class="orders-list">
                @for (order of orders(); track order.id) {
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <span class="order-id">Order #{{ order.id }}</span>
                            <span class="order-date">{{ order.createdAt | date:'mediumDate' }}</span>
                        </div>
                        <div class="order-actions">
                            <span class="status-badge" [class]="getStatusClass(order.status)">
                                @if (order.status === 'accepted') {
                                âœ… Accepted
                                } @else if (order.status === 'rejected') {
                                âŒ Rejected
                                } @else if (order.status === 'cancelled') {
                                ğŸš« Cancelled
                                } @else {
                                â³ Pending
                                }
                            </span>
                            @if (order.status === 'pending') {
                            <button class="cancel-btn" (click)="cancelOrder(order.id)" title="Cancel Order">
                                Cancel
                            </button>
                            }
                        </div>
                    </div>

                    <div class="order-items">
                        @for (item of order.items; track item.productId) {
                        <div class="order-item">
                            <span class="item-name">{{ item.productName }}</span>
                            <span class="item-qty">x{{ item.quantity }}</span>
                            <span class="item-price">Rs. {{ item.price * item.quantity }}</span>
                        </div>
                        }
                    </div>

                    <div class="order-footer">
                        <div class="order-total">
                            <span>Total:</span>
                            <strong>Rs. {{ order.total }}</strong>
                        </div>
                        <button class="message-toggle-btn" (click)="toggleMessages(order.id)">
                            ğŸ’¬ {{ expandedOrderId === order.id ? 'Hide Messages' : 'Message Farmer' }}
                        </button>
                    </div>

                    @if (expandedOrderId === order.id) {
                    <div class="messages-section">
                        @if (loadingMessages[order.id]) {
                        <p class="loading-messages">Loading messages...</p>
                        } @else {
                        <div class="messages-list">
                            @if (!messages[order.id] || messages[order.id].length === 0) {
                            <p class="no-messages">No messages yet. Start a conversation!</p>
                            }
                            @for (msg of messages[order.id]; track msg.id) {
                            <div class="message" [class.my-message]="msg.senderRole === 'buyer'">
                                <div class="message-header">
                                    <span class="sender">{{ msg.senderName }}</span>
                                    <span class="time">{{ msg.createdAt | date:'short' }}</span>
                                </div>
                                <p class="message-content">{{ msg.content }}</p>
                            </div>
                            }
                        </div>
                        <div class="message-input">
                            <input type="text" [(ngModel)]="newMessage[order.id]" placeholder="Type a message..."
                                (keyup.enter)="sendMessage(order.id)">
                            <button class="send-btn" (click)="sendMessage(order.id)">Send</button>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>
</section>